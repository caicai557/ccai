# 详细重构计划（2026最佳实践）

## 一、总原则

1. 契约先行：先定义边界，再改实现。  
2. 小步可回滚：每个阶段都有进入条件、退出条件、回滚策略。  
3. 先稳后快：先恢复质量基线，再并行优化。  
4. 自动化优先：所有关键结论都要可通过脚本复现。  

## 二、阶段划分

## 阶段A：基线修复（Blocking）

目标：恢复可持续开发能力。  
时序：先做，必须完成后才能进入后续阶段。

### A1. 数据基线修复

- 统一 `accounts` 表字段（含 `health_score`、`add_method`）并补迁移。
- 对历史库执行迁移验证与回滚演练。
- 验收：
  - 不再出现 `no such column: health_score`。
  - 关键 DAO 单测可稳定通过。

### A2. 工程基线修复

- 修复 TS 严格规则错误（unused、override、index signature）。
- 修复 ESLint env/project 配置：
  - 后端包含 Node globals 与 test 文件 project。
  - 前端包含浏览器 timers/localStorage globals。
- 验收：
  - `pnpm --filter @telegram-manager/backend build` 通过。
  - `pnpm --filter @telegram-manager/frontend build` 通过。
  - `pnpm -r lint` 通过。

### A3. 测试基线修复

- 重新分层测试：
  - PR 流水线：单测 + 集成 + 契约 + E2E冒烟。
  - 夜间流水线：property tests。
- 修复 DB 生命周期问题（连接关闭、测试隔离、并发污染）。
- 验收：
  - PR 流水线稳定通过率 > 95%。
  - 夜间 property tests 可独立跑完并可重试。

## 阶段B：契约收敛（Core Refactor）

目标：消除前后端模型漂移。

### B1. API/WS 契约统一

- 产出 OpenAPI 规范和 WS 消息协议文档。
- 服务端引入运行时校验（建议 Zod）。
- 统一错误响应模型（code/message/details）。

### B2. 前端消费统一

- 由契约生成客户端类型与调用层。
- 删除或最小化手写转换逻辑。
- 将兼容映射集中到单独 `adapter` 层。

### B3. 配置源收敛

- 确认唯一配置源（建议仅保留 backend/config 或根 config 其中之一）。
- 配置读取路径统一，删除重复项。

验收：
- 契约变更可自动触发前端类型更新。
- 关键接口无“隐式字段”。

## 阶段C：发布治理（上线保障）

目标：把重构结果变成稳定发布能力。

### C1. CI 质量门

- 必过项：
  - build（backend/frontend）
  - lint
  - 单测/集成
  - 契约测试
  - E2E 冒烟

### C2. 发布与回滚

- 增加发布检查单和回滚脚本演练。
- 灰度策略（如需要）和失败自动回退。

### C3. 可观测性

- 统一日志字段（traceId/taskId/accountId）。
- 关键业务指标（任务成功率、消息发送失败率、WS连接稳定性）。

验收：
- 可执行一键质量检查脚本并通过。
- 可执行一次完整上线+回滚演练。

## 三、里程碑定义

## M1（阶段A完成）

- 工程全绿：`build + lint + test(稳定集)`。
- 数据层无漂移。

## M2（阶段B完成）

- API/WS 契约单一化。
- 前端消费层去漂移。

## M3（阶段C完成）

- 发布流程固化，重构关闭。

## 四、风险与应对

1. 风险：历史数据迁移破坏。  
   应对：迁移前备份 + 干跑 + 回滚演练。

2. 风险：可破坏兼容导致前端短期不可用。  
   应对：契约版本化 + 前端同批次升级。

3. 风险：测试重构周期拉长。  
   应对：先划分稳定集和夜间集，保证主线交付不阻塞。
